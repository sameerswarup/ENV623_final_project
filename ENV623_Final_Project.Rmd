---
title: "ENV623_Final_Project"
author: "Sameer, Josh, Graham"
date: '2025-04-13'
output: pdf_document
---

```{r clear-project}
rm(list=ls())
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r import-libraries}
library(dplyr)
library(readxl)
library(tidyr)
library(tibble)
library(stringr)

load("./climate_data/monthlyClimateKruger.rdata")
```

```{r import-elephant}

e_dat <- read.csv("./wildlife_insights_data/images_2009198.csv")
deployments_dat <- read.csv("./wildlife_insights_data/deployments.csv")

e_dat |>
  summarise(
    n_proboscidea = sum(order == "Proboscidea"),
    n_elephantidae = sum(family == "Elephantidae"),
    n_loxodonta = sum(genus == "Loxodonta"),
    n_loxodonta_africana = sum(species == "africana")
  ) |>
  print()

# Proboscidae is sufficent to guarantee African elephant, and
# As we can see, some datapoints are not sufficiently labeled
e_dat <- e_dat[e_dat$order == "Proboscidea", ]

site_counts <- e_dat |>
  count(deployment_id)

deployments_dat <- deployments_dat |>
  left_join(site_counts, by = "deployment_id") |>
  mutate(n = coalesce(n, 0))
```

```{r}
# rm(e_dat_filtered)
# testing_dat <- read.csv("./wildlife_insights_data/images_2009198.csv")
# table(testing_dat$identified_by)

```

```{r}
table(e_dat$deployment_id)

table(deployments_dat$start_date)

table(deployments_dat$end_date)

table((deployments_dat$placename))

# Elephant Presence by location
intersect(unique(e_dat$placename), unique(deployments_dat$placename))
setdiff(unique(deployments_dat$placename), unique(e_dat$placename))

# Elephant Presence by camera site
intersect(unique(e_dat$deployment_id), unique(deployments_dat$deployment_id))
setdiff(unique(deployments_dat$deployment_id), unique(e_dat$deployment_id))
```

```{r}
#Import iNaturalist data on trees
iNat <- read.csv("./ENV 623 - iNaturalist Observations.csv")
```

```{r}
#Define function to translate site name to placename
translate_code <- function(codes) {
  # Match: VRP<prefix>_<optional R><number><optional R>
  matches <- str_match(codes, "VRP(.*?)(?:_R|_)?(\\d+)(R)?")
  
  prefix <- matches[, 2]       # text after VRP
  number <- matches[, 3]       # digits
  paste0(prefix, "_", number, "R")
}
```

```{r}
#Filter to relevant columns and only trees
#Select rows where crown diameter is NA so it is only trees
tree_data <- iNat %>%
             filter(is.na(field.crownradius)) %>%
             select(latitude, longitude, species_guess, scientific_name, common_name, field.stemdiameter, field.treeidentifier) %>%
             mutate(field.treeidentifier = toupper(field.treeidentifier)) %>%
             mutate(site_name = translate_code(field.treeidentifier))
```

```{r}
#Read in and clean monthly precipitation data
prec_df <- as.data.frame(prec)

prec_df <- prec_df %>%
  rownames_to_column(var = "location")

prec_clean <- prec_df %>%
  mutate(
    location = gsub("^E", "", location),        # remove leading 'E'
    location = gsub("_N=|_N", "_", location)    # convert '_N=26' or '_N26' into '_26'
  ) %>%
  separate(location, into = c("longitude", "latitude"), sep = "_") %>%
  mutate(
    longitude = as.numeric(longitude),
    latitude = as.numeric(latitude)
  ) %>%
  mutate(latitude_1_dp = round(latitude, 1),
                    longitude_1_dp = round(longitude, 1)) %>%
  group_by(latitude_1_dp, longitude_1_dp) %>%
  summarise(avg_2023_03_prec = mean(`2023_03`, na.rm = TRUE)) %>%
  select(latitude_1_dp, longitude_1_dp, avg_2023_03_prec)

```

```{r}
#Read in and clean monthly temperature data
temp_df <- as.data.frame(temp)

temp_df <- temp_df %>%
  rownames_to_column(var = "location")

temp_clean <- temp_df %>%
  mutate(
    location = gsub("^E", "", location),        # remove leading 'E'
    location = gsub("_N=|_N", "_", location)    # convert '_N=26' or '_N26' into '_26'
  ) %>%
  separate(location, into = c("longitude", "latitude"), sep = "_") %>%
  mutate(
    longitude = as.numeric(longitude),
    latitude = as.numeric(latitude)
  ) %>%
  mutate(latitude_1_dp = round(latitude, 1),
                    longitude_1_dp = round(longitude, 1)) %>%
  group_by(latitude_1_dp, longitude_1_dp) %>%
  summarise(avg_2023_03_temp = mean(`2023_03`, na.rm = TRUE)) %>%
  select(latitude_1_dp, longitude_1_dp, avg_2023_03_temp)

```

```{r}
#Read in and clean monthly temperature data
pet_df <- as.data.frame(pet)

pet_df <- pet_df %>%
  rownames_to_column(var = "location")

pet_clean <- pet_df %>%
  mutate(
    location = gsub("^E", "", location),        # remove leading 'E'
    location = gsub("_N=|_N", "_", location)    # convert '_N=26' or '_N26' into '_26'
  ) %>%
  separate(location, into = c("longitude", "latitude"), sep = "_") %>%
  mutate(
    longitude = as.numeric(longitude),
    latitude = as.numeric(latitude)
  ) %>%
  mutate(latitude_1_dp = round(latitude, 1),
                    longitude_1_dp = round(longitude, 1)) %>%
  group_by(latitude_1_dp, longitude_1_dp) %>%
  summarise(avg_2023_03_pet = mean(`2023_03`, na.rm = TRUE)) %>%
  select(latitude_1_dp, longitude_1_dp, avg_2023_03_pet)

```

```{r}
#Left join temp, prec to tree data on lat and long 
tree_final <- tree_data %>%
              mutate(latitude_1_dp = round(latitude, 1),
                    longitude_1_dp = round(longitude, 1)) %>%
              left_join(prec_clean, by = c("latitude_1_dp", "longitude_1_dp")) %>%
              left_join(temp_clean, by = c("latitude_1_dp", "longitude_1_dp")) %>%
              left_join(pet_clean, by = c("latitude_1_dp", "longitude_1_dp"))
```


```{r}
#Mixed effects model: Tree Diameter ~ Elephant Presence + Site + Soil type + Temperature + Precipitation
# Variable effects: Soil Type, 


```

