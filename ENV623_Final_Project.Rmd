---
title: "ENV623_Final_Project"
author: "Sameer, Josh, Graham"
date: '2025-04-13'
output: pdf_document
---

```{r clear-project}
rm(list=ls())
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r import-libraries}
library(dplyr)
library(readxl)
library(tidyr)
library(tibble)
library(hdm)

load("./climate_data/monthlyClimateKruger.rdata")
```

```{r import-elephant}

e_dat <- read.csv("./wildlife_insights_data/images_2009198.csv")
deployments_dat <- read.csv("./wildlife_insights_data/deployments.csv")

e_dat |>
  summarise(
    n_proboscidea = sum(order == "Proboscidea"),
    n_elephantidae = sum(family == "Elephantidae"),
    n_loxodonta = sum(genus == "Loxodonta"),
    n_loxodonta_africana = sum(species == "africana")
  ) |>
  print()

# Proboscidae is sufficent to guarantee African elephant, and
# As we can see, some datapoints are not sufficiently labeled
e_dat <- e_dat[e_dat$order == "Proboscidea", ]
e_dat <- e_dat[, c("deployment_id", "location", "timestamp", "number_of_objects")]

deployments_dat <- deployments_dat[, c("deployment_id", "placename", "longitude", "latitude", "start_date", "end_date", "camera_id", "camera_name")]

# Convert to time format
e_dat$timestamp <- as.POSIXct(e_dat$timestamp, format = "%Y-%m-%d %H:%M:%S")
str(e_dat$timestamp)

deployments_dat$start_date <- as.POSIXct(deployments_dat$start_date, format = "%Y-%m-%d %H:%M:%S")
deployments_dat$end_date <- as.POSIXct(deployments_dat$end_date, format = "%Y-%m-%d %H:%M:%S")
str(deployments_dat$end_date)
str(deployments_dat$start_date)

#site_counts <- e_dat |>
#  count(deployment_id)

deployments_dat$days <- round(as.numeric(deployments_dat$end_date - deployments_dat$start_date, units = "days"))


site_counts <- e_dat |>
  group_by(deployment_id) |>
  summarise(
    counts = sum(number_of_objects, na.rm = TRUE),
    counts_f21 = sum(number_of_objects[timestamp >= as.POSIXct("2025-02-21")], na.rm = TRUE)
  )

deployments_dat <- deployments_dat |>
  left_join(site_counts, by = "deployment_id") |>
  mutate(
    counts = coalesce(counts, 0),
    counts_f21 = coalesce(counts_f21, 0)
  )

deployments_dat$norm_counts <- deployments_dat$counts / deployments_dat$days
deployments_dat$norm_counts_f21 <- deployments_dat$counts_f21 / min(deployments_dat$days, na.rm = TRUE)



# Print totals
print(sum(deployments_dat$num_elephants, na.rm = TRUE))
print(sum(deployments_dat$num_elephants_f21, na.rm = TRUE))

```

```{r}
# rm(e_dat_filtered)
testing_e_dat <- read.csv("./wildlife_insights_data/images_2009198.csv")
# table(testing_dat$identified_by)

```

```{r}
table(e_dat$deployment_id)

table(deployments_dat$start_date)

table(deployments_dat$end_date)

table((deployments_dat$placename))

# Elephant Presence by location
intersect(unique(e_dat$placename), unique(deployments_dat$placename))
setdiff(unique(deployments_dat$placename), unique(e_dat$placename))

# Elephant Presence by camera site
intersect(unique(e_dat$deployment_id), unique(deployments_dat$deployment_id))
setdiff(unique(deployments_dat$deployment_id), unique(e_dat$deployment_id))
```

```{r}
#Import iNaturalist data on trees
iNat <- read.csv("./ENV 623 - iNaturalist Observations.csv")
```

```{r}
#Filter to relevant columns and only trees
#Select rows where crown diameter is NA so it is only trees
tree_data <- iNat %>%
             filter(is.na(field.crownradius)) %>%
             select(latitude, longitude, species_guess, scientific_name, common_name, field.stemdiameter, field.treeidentifier) %>%
             mutate(longitude = round(longitude, 4))
```

```{r}
#Left join deployments to tree data to get sites
tree_w_sites <- tree_data %>%
                left_join(deployments_dat, by = c("longitude"))
```


```{r}
#Read in and clean monthly precipitation data
prec_df <- as.data.frame(prec)

prec_df <- prec_df %>%
  rownames_to_column(var = "location")

prec_clean <- prec_df %>%
  mutate(
    location = gsub("^E", "", location),        # remove leading 'E'
    location = gsub("_N=|_N", "_", location)    # convert '_N=26' or '_N26' into '_26'
  ) %>%
  separate(location, into = c("longitude", "latitude"), sep = "_") %>%
  mutate(
    longitude = as.numeric(longitude),
    latitude = as.numeric(latitude)
  ) %>%
  select(latitude, longitude, `2023_03`) %>%
  mutate(latitude = round(latitude, 1),
                    longitude = round(longitude, 1)) %>%
  group_by(latitude, longitude) %>%
  summarise(avg_2023_03_prec = mean(`2023_03`, na.rm = TRUE))

```

```{r}
#Read in and clean monthly temperature data
temp_df <- as.data.frame(temp)

temp_df <- temp_df %>%
  rownames_to_column(var = "location")

temp_clean <- temp_df %>%
  mutate(
    location = gsub("^E", "", location),        # remove leading 'E'
    location = gsub("_N=|_N", "_", location)    # convert '_N=26' or '_N26' into '_26'
  ) %>%
  separate(location, into = c("longitude", "latitude"), sep = "_") %>%
  mutate(
    longitude = as.numeric(longitude),
    latitude = as.numeric(latitude)
  ) %>%
  select(latitude, longitude, `2023_03`) %>%
  mutate(latitude = round(latitude, 1),
                    longitude = round(longitude, 1)) %>%
  group_by(latitude, longitude) %>%
  summarise(avg_2023_03_temp = mean(`2023_03`, na.rm = TRUE))

```

```{r}
#Left join temp, prec to tree data on lat and long 
tree_final <- tree_data %>%
              left_join(prec_clean, by = c("latitude", "longitude")) %>%
              left_join(temp_clean, by = c("latitude", "longitude"))
```

```{r lasso-model}
# Y ~ X + W
# Y: Tree Diameter
# X: Elephant Counts
# W: Temperature, Precipitation, PET (Potential Evapotranspiration)


#cat("Running Lasso for outcome model (Y ~ W)...\n")
#lasso_y <- rlasso(x = W, y = d[[outcome]], post = FALSE) 
#selected_y_vars <- names(coef(lasso_y))[coef(lasso_y) != 0]
#selected_y_vars <- setdiff(selected_y_vars, "(Intercept)")
#cat("Variables selected for outcome model:", length(selected_y_vars), "\n")

```



```{r}
#Mixed effects model: Tree Diameter ~ Elephant Presence + Site + Soil type + Temperature + Precipitation
# Variable effects: Soil Type, 


```

